# Geoextractor
**An interface to connect MaGe simulations to pulse shape simulations of ADL and SIGGEN.**

Achieved by read-in of MaGe .ROOT files into Geoextractor, resulting in the generation of output files for each detector in the native formats of ADL, siggen, and JSON files with all detector and hit information.

## Description
<img src="https://cloud.githubusercontent.com/assets/8874125/26146179/8599ca30-3aef-11e7-8f77-f027e7628c24.png" width="690" height="208" />

MaGe simulations : .ROOT output into Geoextractor
* Geoextractor generates all necessary files for ADL and SIGGEN in their native format. 

Geoextractor **extracts** automatically:
* Detector absolute position inside of MaGe. [.GDML]
* Detector parameters (radius, length, dead layer size, etc.). [.GDML]
* Hit positions transformed into the individual detector frames. [.ROOT]

**Input** for Geoextractor:
* .GDML file extracted from MaGe geometry through MaGe macro.
* detsettings file that contains additional information (e.g. HV).
* .ROOT files of a Monte Carlo simulation with the same MaGe geometry.

**Output** automatically generated by Geoextractor:
* .JSON file for each detector (transformed hit positions/energy/particleID, detector parameters, detector absolute positions)
* .config files for SIGGEN for each detector (detector parameters)
* DET & DET_SETUP files for ADL (detector parameters)
* (hit parameters in simple .txt file for test purposes, but will be replaced fully by JSON usage for all programs)

## Installation

Installation from github in directory of choice:
```
git clone git@github.com:mmilor/Geoextractor.git
```
If you encounter any problems during installation or usage, please let me know. Try the LNGS Cluster method mentioned in the Exercise at the bottom and see if the problem persists.

## Usage
The working directory after installation already contains:
* GDML file 'gdml.gdml' suitable for GERDA Phase II created with the detector- and matrixfiles:
  * geometry_PhaseII_BEGeFCCDgrowth_CoaxPhaseI.dat
  * matrix_phase_ii_StatusDec2015_pos.dat
  * both found here: https://github.com/mppmu/MaGe/tree/GERDAphaseII/gerdageometry
* 'detsettings.txt' file that contains additional information about the GERDA Phase II detectors. Any upgrade with addition channels, change of HV etc. means that this file needs to be edited, but Geoextractor does not need to be recompiled.

These default input files are usually enough for the GERDA Phase II geometry. 
If a different arrangement or detector- and matrixfile combination is desired, a new gdml file can be produced as described later on in the section "Producing New .GDML Files".

Geoextractor can be run directly as CINT ROOT program or compiled standalone. 

### Compile and run
Geoextractor is compiled with the following command:
```
cd /path/to/Geoextractor
make
```

Options:
*	**-m, --mcdir PATH**:	Specify input path for ROOT files to be merged and used for extraction. Default: MC_DIR shell variable.
*	**-a, --adl PATH**:	Specify output path for ADL files. Default: ./Output/adl
*	**-j, --json PATH**:	Specify output path for JSON files. Default: ./Output/json
*	**-s, --siggen PATH**:	Specify output path for SIGGEN files. Default: ./Output/siggen
*	**-g, --gdml PATH**:	Specify path to GDML file. Default: ./defaultgdml.gdml
*	**-d, --detsettings PATH**:	Specify path to Detector Settings file. Default: ./detsettings.txt
*	**-x, --maxhits INT**:	Limit amount of hits per detector to be extracted and written to file to a fixed number. Default: No limit.
* **-v, --vishits STRING**: Visualise hit extraction with condition set by STRING. Example to show only events in detector 33: --v hits_iddet==33
*	**-n, --nohits**: 	Skip all hit extraction, only extract geometry.
* **-c, --checkgdml**: 	Visualise .GDML file with OGL drivers. Best to use: root Geoextractor.cxx+(1)
*	**-h, --help**:		Show help message

To extract only the geometries without any hits, use the command: 
```
./Geoextractor --nohits
```

In order to extract hits out of .ROOT files, the directory of the files needs to be specified (The files should be simulated in the same detector- and matrixfile configuration as the .GDML file.). 

There are two options (order of priority):
* Via option: **-m,--mcdir PATH**
* Via shell variable $MC_DIR pointing to the directory

To specify $MC_DIR, use the following shell commands:  
```
cd /path/to/MCSimulations
export MC_DIR=$(pwd)
```
Simply evoking the program is then enough to extract into the default folders:
```
cd /path/to/Geoextractor
./Geoextractor
```

### Run with CINT ROOT 
Geoextractor can also be run directly by CINT ROOT.
First the shell variable $MC_DIR should be set to the directory of the .ROOT MC files from where the hits should be extracted. (The files should be simulated in the same detector- and matrixfile configuration as the .GDML file.) 
```
cd /path/to/MCSimulations
export MC_DIR=$(pwd)
cd /path/to/Geoextractor
```

When in the Geoextractor directory, the program will be executed by simply evoking:
```
root Geoextractor.cxx
```
In this configuration, Geoextractor will use default options and use as Input:
* 'defaultgdml.gdml' in the Geoextractor directory
* 'detsettings.txt' in the Geoextractor directory
* All .ROOT files contained in the directory pointed at by shell variable $MC_DIR 

The Output will be saved in the directories: 
* /Output/adl
* /Output/json
* /Output/siggen

This is an easy method to get results.

### Producing New .GDML Files
The GDML file is a file that stores the geometry from MaGe into a compact format, such that we do not depend directly MaGe anymore, once we have extracted the geometry. Read through the chapter **Usage** to learn more.
If a different arrangement or detector- and matrixfile combination is desired, a new gdml file can be produced with a GDML macro provided in the working directory: 'gdmlextractor.mac'. It needs to be edited by changing only three lines to the appropriate new file names:
```
In gdmlextractor.mac:
(...)
/MG/geometry/detector/geometryfile geometry_PhaseII_FCCD_growth.dat
/MG/geometry/detector/matrixfile matrix_phase_ii_StatusDec2015_pos_vis.dat
(...)
/MG/geometry/GDML/outputName extractedgdml
```
Make sure to use the _pos_vis.dat matrixfile and check the gdml later on visually.
Then MaGe needs to be run with the macro. gdmlextractor.mac can for example be copied to the MaGe path and executed from there.
```
cd /path/to/MaGe
./MaGe gdmlextractor.mac
```
This results in a file 'extractedgdml.gdml' (depending on how the macro was edited) in the MaGe folder. Geoextractor can link to the .gdml file with the command **-g, --gdml PATH**. Another possibility is to rename the defaultfile in Geoextractor folder and copy and rename your new GDML to 'defaultgdml.gdml' to automatically use this file without needing any options.

To visually check the .GDML file, use ROOT CINT with BASH terminal and the command (explained in the corresponding section): 
```
root Geoextractor.cxx+(1)
```
This sets the checkGDML option to true and enables you to look at a OGL rendering of the GDML file.
<img src="https://cloud.githubusercontent.com/assets/8874125/26146405/5d0198c2-3af0-11e7-852b-6f385b1d4be8.png" width="480" height="480" />
  <details>
  <summary>Click here for a close up</summary>
  <img src="https://cloud.githubusercontent.com/assets/8874125/26146409/5e2bc2d6-3af0-11e7-8d82-0a673cf72e0e.png" width="480" height="480" />
</details>


## File formatting
The ADL and SIGGEN file structure for the detector geometries/parameters are given by the individual programs. The JSON formatting is created for Geoextractor and looks as follows (here for GD00A and two hits):
```
{ 
    "detector": "GD00A",
    "magechannel": "33",
    "type": "BEGe",
    "mageposition": 
        [
            { "detcenter_xpos": "55", "detcenter_ypos": "-95.2628", "detcenter_zpos": "67.7497" }
        ],
    "parameters": 
        [
            { "detdimx": "34.25", "detdimy": "34.25", "detdimz": "12.7497", "xtal_radius": "34.25", "xtal_length": "25.4994", "pc_length": "3e-4", "pc_radius": "7.5", "wrap_around_radius": "10.5", "ditch_depth": "2", "ditch_thickness": "3", "outer_taper_length": "12.06", "outer_taper_width": "11.92", "Li_thickness": "0.91", "impurity_z0": "-1", "impurity_gradient": "0.0454", "xtal_HV": "2500" }
        ],
    "hits": 
        [
            { "id": "0", "eventnumber": "2276", "xpos": "-29.9293", "ypos": "-2.55369", "zpos": "13.0999", "edep": "11.067", "trackpdg": "22" },
            { "id": "1", "eventnumber": "27604", "xpos": "19.1338", "ypos": "-25.4563", "zpos": "11.7349", "edep": "0.12938", "trackpdg": "22" }
        ]
}
``` 
* **detcenter_xpos/ypos/zpos** describe the absolute position of the detector center in the MaGe coordinate system.
* **detdimx/y/z** describe the dimensions of the detector in each direction from the center point. Point contact position thus is detcenter_xpos, detcenter_ypos, detcenter_zpos-detdimz. Inverted detectors: " " detcenter_zpos+detdimz.
* xtal_radius, length etc are described here: radware.phy.ornl.gov/MJ/mjd_siggen/fieldgen_geometry.pdf
* **xpos, ypos, zpos** are the coordinates of each hit already transformed into the detector frame with the point contact being (0,0,0). (Inverted detectors are already taken into consideration here).

To be added:
* inverted (already used/determined/known, but not yet written into JSON file)
* coax Li_thickness faulty atm, needs to be fixed
* ...

## Plans
* Unify JSON usage for hits read-in for SIGGEN and ADL.
* Work out optimal file formatting.
* SSE/MSE identification and categorisation inside JSON.
* Proper geometry extraction for Coax as well. (Currently only verified with BEGes)
* Bugtesting.

### Prerequisites
Geoextractor:
* ROOT

GDML macro:
* MaGe

MaGe for MC simulations:
* GEANT4


## Author

Michael Miloradovic 

## License

This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details



----------------------------------
# Exercise
Learn how to use Geoextractor combined with ADL in this exercise to produce pulse shape simulations from MaGe simulations.

**Preparation**: Install & compile Geoextractor using this README starting from the section **Install**.

**LNGS Cluster Method**: In case there are any problems due to prerequisite program conflicts, test out Geoextractor on the LNGS cluster:
```
ssh -XY name@gerda-login.lngs.infn.it
source /nfs/gerda5/gerda-sw/bin/swmod-env-cpath.sh gerda@dp-v3.0.0
cd /nfs/gerda2/users/
enter your user folder
git clone https://github.com/mmilor/Geoextractor
cd Geoextractor
```
From there you can follow the Exercise directly on the LNGS Cluster.

#### 1.) Extract the GERDA geometry
First, we will take a look at the GERDA geometry and extract it from the .GDML file. For this exercise we will use the provided .GDML file in the parent directory. 
<details>
  <summary>Click here for a picture of an OGL Rendering of the provided .GDML</summary>
  <img src="https://cloud.githubusercontent.com/assets/8874125/26146405/5d0198c2-3af0-11e7-852b-6f385b1d4be8.png" width="480" height="480" />
  </details>
<details>
  <summary>And a close up</summary>
  <img src="https://cloud.githubusercontent.com/assets/8874125/26146409/5e2bc2d6-3af0-11e7-8d82-0a673cf72e0e.png" width="480" height="480" />
</details>
(To learn how and why to produce new .GDML files and visualise them yourself, check out the chapter **Producing New .GDML Files**.)

If we want to extract the GERDA geometry from this GDML and nothing else, we can invoke Geoextractor in the following way: 
```
./Geoextractor --nohits
```
Read through the terminal output, showing:
* Detector name and channel
* Node in GDML
* Dimensions from the coordinate center of a detector (in cm)
* Shape 
* Coordinate center in the absolute MaGe frame (in cm)
* Point contact center in the absolute MaGe frame (in cm) (includes inversion of detector)
* Where the information is stored in
* Active volume fiducial cut

All this information is then used to create output files stored in the Output directory. Navigate to the Output directory and you see three directories:
* adl/ConfigFiles
  * ADL geometry files are generated automatically: SETUP and DET files containing detector geometry information
* json
  * .JSON files which contain detector geometry information (and later on hit information)
* siggen
  * .config files for SIGGEN automatically generated.
These are all the output files which are used then directly in ADL & siggen. In the future other programs can make use of the general extraction in the .json format.

Since the detector geometries are output into native ADL & siggen formats, the fields can be simulated directly with these programs for each detector.

Let's move on to simulated events that store energy inside the germanium detector via interactions (hits), how they are simulated with MaGe, and how they can be transferred to pulse shape simulation software (ADL & siggen) via Geoextractor.


#### 2.) Monte Carlo simulations from MaGe
MaGe receives a macro in which you declare: 
* geometryfile (dimensions of detectors, dead layer etc.).
* matrixfile (arrangement of detectors on string).
* What interaction to simulate and originating in what volume.

In this exercise, this simulation was already performed and the .ROOT files of the simulation are stored in the Geoextractor/Exercise/ folder.
The details:
* geometryfile: geometry_PhaseII_FCCD_growth.dat 
* matrixfile: matrix_phase_ii_StatusDec2015_pos.dat
* Ar39 decay in a sphere around the whole array.

The .ROOT files are not compatible with the pulse shape simulation softwares ADL or SIGGEN, so we need Geoextractor to do its magic.
To tell Geoextractor what files to use, you can navigate to the Exercise folder and declare in the same way as for Background Model software:
```
export MC_DIR=$(pwd)
```
And then navigate back to the Geoextractor parent folder.
Geoextractor will then use all .ROOT files in your MC_DIR and merge them to TChains to analyse. Of course there is also the option to use -m, --mcdir as described in the **Usage** part of the README.

#### 3.) Hits Visualisation with Geoextractor
In the Geoextractor directory (/Geoextractor/), run Geoextractor to visualise the simulation directly from the root files. Use the -v or --vishits command to do this:
```
./Geoextractor --vishits
```
<details>
  <summary>Result</summary>
  <img src="https://cloud.githubusercontent.com/assets/8874125/26147596/57f1cb50-3af4-11e7-8ae6-ebb3cd4d62c0.png" width="696" height="472" />
</details>

You will see all hits in all 40 GERDA detectors visualised. Let's reduce it to just one detector, for example **detector** with MaGe channel number 33: GD00A. (Remember that for GERDA the data channels and the MaGe channels do not coincide. You can either check the GERDA wiki or the detsettings.txt file to check which channel is which.)
To show only the hits in **GD00A - detector 33** , use:
```
./Geoextractor --vishits hits_iddet==33
```
<details>
  <summary>Result</summary>
  <img src="https://cloud.githubusercontent.com/assets/8874125/26147872/2e676e60-3af5-11e7-94e7-9b60cf555ec0.png" width="696" height="472" />
</details>

Any string that selects events can be used, in the same style as the the Draw() function of ROOT.

#### 4.) Hit extraction with Geoextractor
Finally, we want to extract the hits and automatically transform them into the detector frames such that we can use them directly in ADL & siggen formats. Call Geoextractor with the following command:
```
./Geoextractor
```
You notice that for each detector there is additional number output given, expressing the hits_xpos, hits_ypos, hits_zpos transformed to the point contact frame and deposited energy. All this information and more is stored in the .JSON files in the /Geoextractor/Output/json folder (see chapter **File formatting** for an example). This hit position and energy information, together with the automatically extracted detector geometry can then be used to simulate the fields and the induced pulse shapes in ADL & SIGGEN.
